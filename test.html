<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>이력서 입력</title>
  <style>
    :root {
      --bg: #f4f6f8;
      --card: #fff;
      --text: #111;
      --muted: #666;
      --line: #d9d9d9;
      --primary: #1d78ff;
      --ok: #0b7a35;
      --err: #b42318;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", sans-serif;
    }

    .container {
      max-width: 1100px;
      margin: 40px auto 80px;
      padding: 0 16px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 30px;
      font-weight: 700;
    }

    .desc {
      margin: 0 0 24px;
      color: var(--muted);
      font-size: 14px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 14px;
    }

    .card h2 {
      margin: 0 0 12px;
      font-size: 18px;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field label {
      font-size: 13px;
      color: #333;
    }

    .field input,
    .field select,
    .field textarea {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      background: #fff;
    }

    .field textarea {
      min-height: 130px;
      resize: vertical;
      line-height: 1.5;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(29, 120, 255, 0.12);
    }

    .col-12 { grid-column: span 12; }
    .col-8  { grid-column: span 8; }
    .col-6  { grid-column: span 6; }
    .col-4  { grid-column: span 4; }
    .col-3  { grid-column: span 3; }
    .col-2  { grid-column: span 2; }

    .item {
      border: 1px dashed #c8c8c8;
      border-radius: 12px;
      padding: 12px;
      margin-top: 10px;
      background: #fcfcfc;
    }

    .item-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 600;
    }

    .btn {
      border: 1px solid var(--line);
      background: #fff;
      color: #111;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn:hover { background: #f7f7f7; }

    .btn.primary {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }

    .btn.primary:hover { opacity: 0.95; }

    .btn.danger {
      border-color: #efc3c3;
      color: #8b1b1b;
      background: #fff5f5;
    }

    .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 12px;
    }

    .status {
      margin-top: 10px;
      font-size: 14px;
      min-height: 22px;
    }

    .status.ok { color: var(--ok); }
    .status.err { color: var(--err); }

    @media (max-width: 900px) {
      .col-8, .col-6, .col-4, .col-3, .col-2 { grid-column: span 12; }
      h1 { font-size: 24px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>이력서 입력</h1>
    <p class="desc">자기소개 + 학력 + 경력 + 자격증을 한 번에 저장합니다.</p>

    <!-- 기본 정보 -->
    <section class="card">
      <h2>기본 정보</h2>
      <div class="row">
        <div class="field col-3">
          <label for="userId">사용자 ID</label>
          <input id="userId" type="number" value="1" min="1" />
        </div>
      </div>
    </section>

    <!-- 자기소개 -->
    <section class="card">
      <h2>자기소개(cover)</h2>
      <div class="row">
        <div class="field col-12">
          <label for="cover">
            자기소개 문장 (예: 성장과정/지원동기/입사 후 포부)
          </label>
          <textarea id="cover" placeholder="예) 성장과정: ...&#10;지원동기: ...&#10;입사 후 포부: ..."></textarea>
        </div>
      </div>
    </section>

    <!-- 학력 -->
    <section class="card">
      <h2>학력 (resume_edu)</h2>
      <div id="eduList"></div>
      <div class="actions" style="justify-content: flex-start;">
        <button class="btn" type="button" id="addEduBtn">학력 추가</button>
      </div>
    </section>

    <!-- 경력 -->
    <section class="card">
      <h2>경력 (resume_exp)</h2>
      <div id="expList"></div>
      <div class="actions" style="justify-content: flex-start;">
        <button class="btn" type="button" id="addExpBtn">경력 추가</button>
      </div>
    </section>

    <!-- 자격증 -->
    <section class="card">
      <h2>자격증 (resume_cert)</h2>
      <div id="certList"></div>
      <div class="actions" style="justify-content: flex-start;">
        <button class="btn" type="button" id="addCertBtn">자격증 추가</button>
      </div>
    </section>

    <!-- 저장 -->
    <section class="card">
      <div class="actions">
        <button class="btn primary" id="saveBtn" type="button">전체 저장</button>
      </div>
      <div id="status" class="status" aria-live="polite"></div>
    </section>
  </div>

  <template id="eduTemplate">
    <div class="item edu-item">
      <div class="item-head">
        <span>학력 항목</span>
        <button type="button" class="btn danger remove-item">삭제</button>
      </div>
      <div class="row">
        <div class="field col-4">
          <label>학교명</label>
          <input type="text" data-k="school_name" placeholder="서울대학교" />
        </div>
        <div class="field col-3">
          <label>학위</label>
          <input type="text" data-k="degree_level" placeholder="학사" />
        </div>
        <div class="field col-3">
          <label>전공</label>
          <input type="text" data-k="major" placeholder="컴퓨터공학" />
        </div>
        <div class="field col-2">
          <label>정렬순서</label>
          <input type="number" data-k="display_order" value="1" min="1" />
        </div>

        <div class="field col-2">
          <label>평점</label>
          <input type="number" step="0.01" data-k="gpa" placeholder="3.85" />
        </div>
        <div class="field col-2">
          <label>만점</label>
          <input type="number" step="0.01" data-k="gpa_scale" placeholder="4.50" />
        </div>
        <div class="field col-3">
          <label>시작일</label>
          <input type="date" data-k="start_date" />
        </div>
        <div class="field col-3">
          <label>종료일</label>
          <input type="date" data-k="end_date" />
        </div>
        <div class="field col-2">
          <label>재학중(0/1)</label>
          <input type="number" data-k="is_current" value="0" min="0" max="1" />
        </div>
        <div class="field col-2">
          <label>최종학력(0/1)</label>
          <input type="number" data-k="last_edu" value="0" min="0" max="1" />
        </div>
      </div>
    </div>
  </template>

  <template id="expTemplate">
    <div class="item exp-item">
      <div class="item-head">
        <span>경력 항목</span>
        <button type="button" class="btn danger remove-item">삭제</button>
      </div>
      <div class="row">
        <div class="field col-4">
          <label>회사명</label>
          <input type="text" data-k="company_name" placeholder="삼성" />
        </div>
        <div class="field col-3">
          <label>직책</label>
          <input type="text" data-k="position" placeholder="인턴" />
        </div>
        <div class="field col-2">
          <label>근무개월수</label>
          <input type="number" data-k="career_month" value="0" min="0" />
        </div>
        <div class="field col-3">
          <label>근무지역</label>
          <input type="text" data-k="location" placeholder="서울" />
        </div>

        <div class="field col-3">
          <label>시작일</label>
          <input type="date" data-k="start_date" />
        </div>
        <div class="field col-3">
          <label>종료일</label>
          <input type="date" data-k="end_date" />
        </div>
        <div class="field col-2">
          <label>재직중(0/1)</label>
          <input type="number" data-k="is_current" value="0" min="0" max="1" />
        </div>
        <div class="field col-2">
          <label>정렬순서</label>
          <input type="number" data-k="display_order" value="1" min="1" />
        </div>
      </div>
    </div>
  </template>

  <template id="certTemplate">
    <div class="item cert-item">
      <div class="item-head">
        <span>자격증 항목</span>
        <button type="button" class="btn danger remove-item">삭제</button>
      </div>
      <div class="row">
        <div class="field col-4">
          <label>자격증명</label>
          <input type="text" data-k="cert_name" placeholder="컴활" />
        </div>
        <div class="field col-4">
          <label>자격번호</label>
          <input type="text" data-k="credential_id" placeholder="1234" />
        </div>
        <div class="field col-2">
          <label>취득일</label>
          <input type="date" data-k="issued_date" />
        </div>
        <div class="field col-2">
          <label>만료일(선택)</label>
          <input type="date" data-k="expire_date" />
        </div>
      </div>
    </div>
  </template>

  <script>
    const eduList = document.getElementById("eduList");
    const expList = document.getElementById("expList");
    const certList = document.getElementById("certList");

    const addEduBtn = document.getElementById("addEduBtn");
    const addExpBtn = document.getElementById("addExpBtn");
    const addCertBtn = document.getElementById("addCertBtn");

    const saveBtn = document.getElementById("saveBtn");
    const statusEl = document.getElementById("status");

    function setStatus(msg, type = "") {
      statusEl.textContent = msg || "";
      statusEl.className = "status" + (type ? ` ${type}` : "");
    }

    function createItem(templateId, target) {
      const tpl = document.getElementById(templateId);
      const node = tpl.content.firstElementChild.cloneNode(true);
      node.querySelector(".remove-item").addEventListener("click", () => node.remove());
      target.appendChild(node);
      return node;
    }

    function readItems(containerSelector) {
      const items = Array.from(document.querySelectorAll(containerSelector));
      return items.map((item) => {
        const obj = {};
        item.querySelectorAll("[data-k]").forEach((el) => {
          const key = el.dataset.k;
          let val = el.value;

          if (val === "") val = null;
          if (key === "is_current" || key === "last_edu" || key === "display_order" || key === "career_month") {
            val = val === null ? 0 : Number(val);
          }
          if (key === "gpa" || key === "gpa_scale") {
            val = val === null ? null : Number(val);
          }

          obj[key] = val;
        });
        return obj;
      });
    }

    function seedDefaultData() {
      // 학력 기본 2개
      const e1 = createItem("eduTemplate", eduList);
      e1.querySelector('[data-k="school_name"]').value = "서울고등학교";
      e1.querySelector('[data-k="degree_level"]').value = "고등학교";
      e1.querySelector('[data-k="start_date"]').value = "2013-03-01";
      e1.querySelector('[data-k="end_date"]').value = "2016-02-29";
      e1.querySelector('[data-k="is_current"]').value = "0";
      e1.querySelector('[data-k="last_edu"]').value = "0";
      e1.querySelector('[data-k="display_order"]').value = "1";

      const e2 = createItem("eduTemplate", eduList);
      e2.querySelector('[data-k="school_name"]').value = "서울대학교";
      e2.querySelector('[data-k="degree_level"]').value = "학사";
      e2.querySelector('[data-k="major"]').value = "컴퓨터공학";
      e2.querySelector('[data-k="gpa"]').value = "3.5";
      e2.querySelector('[data-k="gpa_scale"]').value = "4.5";
      e2.querySelector('[data-k="start_date"]').value = "2018-03-01";
      e2.querySelector('[data-k="end_date"]').value = "2022-02-28";
      e2.querySelector('[data-k="is_current"]').value = "0";
      e2.querySelector('[data-k="last_edu"]').value = "1";
      e2.querySelector('[data-k="display_order"]').value = "2";

      // 경력 기본 1개
      const x1 = createItem("expTemplate", expList);
      x1.querySelector('[data-k="company_name"]').value = "삼성";
      x1.querySelector('[data-k="position"]').value = "인턴";
      x1.querySelector('[data-k="start_date"]').value = "2025-04-01";
      x1.querySelector('[data-k="end_date"]').value = "2025-07-01";
      x1.querySelector('[data-k="career_month"]').value = "3";
      x1.querySelector('[data-k="is_current"]').value = "0";
      x1.querySelector('[data-k="location"]').value = "서울";
      x1.querySelector('[data-k="display_order"]').value = "1";

      // 자격증 기본 1개
      const c1 = createItem("certTemplate", certList);
      c1.querySelector('[data-k="cert_name"]').value = "컴활";
      c1.querySelector('[data-k="issued_date"]').value = "2024-07-12";
      c1.querySelector('[data-k="credential_id"]').value = "1234";
    }

    addEduBtn.addEventListener("click", () => createItem("eduTemplate", eduList));
    addExpBtn.addEventListener("click", () => createItem("expTemplate", expList));
    addCertBtn.addEventListener("click", () => createItem("certTemplate", certList));

    saveBtn.addEventListener("click", async () => {
      const userId = Number(document.getElementById("userId").value);
      const cover = document.getElementById("cover").value.trim();

      if (!userId || userId < 1) {
        setStatus("user_id를 올바르게 입력하세요.", "err");
        return;
      }
      if (!cover) {
        setStatus("자기소개(cover)를 입력하세요.", "err");
        return;
      }

      const payload = {
        user_id: userId,
        cover,
        edu_list: readItems(".edu-item"),
        exp_list: readItems(".exp-item"),
        cert_list: readItems(".cert-item")
      };

      try {
        saveBtn.disabled = true;
        setStatus("저장 중입니다...");

        const res = await fetch("/api/resumes/full", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const raw = await res.text();
        let data = {};
        try { data = raw ? JSON.parse(raw) : {}; } catch { data = { message: raw }; }

        if (!res.ok) {
          throw new Error(data.message || "저장 실패");
        }

        setStatus(`저장 완료: resume_id=${data.resume_id}`, "ok");
      } catch (err) {
        setStatus(`저장 오류: ${err.message}`, "err");
      } finally {
        saveBtn.disabled = false;
      }
    });

    seedDefaultData();
  </script>
</body>
</html>


